<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Peribus Debug Harness</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 1rem; background:#f5f7fa; }
    h1 { font-size:1.25rem; margin:0 0 1rem; }
    .section { margin-bottom:1.5rem; padding:1rem; background:#fff; border:1px solid #dbe1e8; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    code { background:#eef2f7; padding:2px 5px; border-radius:4px; font-size:0.85rem; }
    textarea { width:100%; min-height:140px; font-family:monospace; font-size:0.8rem; }
    button { cursor:pointer; padding:0.5rem 0.85rem; border-radius:6px; border:1px solid #c5ccd4; background:#fff; font-weight:600; }
    button:hover { background:#2563eb; color:#fff; border-color:#2563eb; }
    .log { font-family:monospace; white-space:pre-wrap; background:#0b1e33; color:#d6f1ff; padding:0.75rem; border-radius:6px; max-height:320px; overflow:auto; font-size:0.75rem; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; background:#2563eb; color:#fff; font-size:0.7rem; font-weight:600; letter-spacing:0.5px; }
  </style>
</head>
<body>
  <h1>Peribus Debug Harness</h1>
  <p>Utilisez cette page pour tester localement les fonctions de tri, déduplication et rendu sans déclencher les appels réseau. Les fonctions sont exposées via <code>window.__DEBUG</code>.</p>

  <div class="section">
    <h2 style="margin-top:0;">1. Génération Jeux d'Itinéraires <span class="badge">ARRIVER</span></h2>
    <p>Crée un jeu factice d'itinéraires (mix BUS / WALK / BIKE) avec heures différentes pour tester le tri du mode <code>arriver</code>.</p>
    <button id="btn-generate-arrival">Générer & Trier</button>
    <div id="arrival-log" class="log" aria-label="Résultats arrivée"></div>
  </div>

  <div class="section">
    <h2 style="margin-top:0;">2. Déduplication</h2>
    <p>Injecte doublons intentionnels pour valider <code>deduplicateItineraries</code>.</p>
    <button id="btn-test-dedup">Tester Déduplication</button>
    <div id="dedup-log" class="log" aria-label="Résultats déduplication"></div>
  </div>

  <div class="section">
    <h2 style="margin-top:0;">3. Rendu (DOM faux)</h2>
    <p>Monte un conteneur <code>.results-list</code> isolé, assigne des itinéraires et appelle <code>_debugRender()</code>.</p>
    <button id="btn-test-render">Tester Renderer (ALL)</button>
    <div id="render-host" style="border:1px solid #dbe1e8; border-radius:6px; padding:0.75rem; background:#fff; min-height:120px;"></div>
  </div>

  <div class="section">
    <h2 style="margin-top:0;">4. Outils Individuels</h2>
    <p>Calcul différence horaire & présentation attente.</p>
    <button id="btn-test-utils">Tester Utilitaires</button>
    <div id="utils-log" class="log" aria-label="Résultats utilitaires"></div>
  </div>

  <script type="module">
    import './js/main.js'; // charge et installe window.__DEBUG

    const logJson = (el, obj) => {
      el.textContent = JSON.stringify(obj, null, 2);
    };

    // Helper random
    const pad = (n)=> String(n).padStart(2,'0');
    const makeArrivalTime = (baseHour, offsetMin) => `${pad(baseHour + Math.floor((offsetMin+60)/60) - 1)}:${pad((offsetMin % 60 + 60)%60)}`;

    const createFakeItinerary = (id, type, arrivalHourBase, arrivalOffset, transfers=0, walkMin=0, rawDur=0) => {
      const arrival = makeArrivalTime(arrivalHourBase, arrivalOffset);
      const depMinuteOffset = rawDur; // simplification
      const departure = makeArrivalTime(arrivalHourBase, arrivalOffset - depMinuteOffset);
      return {
        id:`itin-${id}`,
        type,
        arrivalTime: arrival,
        departureTime: departure,
        duration: `${rawDur} min`,
        durationRaw: rawDur,
        summarySegments: type==='BUS' ? [{ name:'L'+id, color:'#2563eb', textColor:'#fff', type:'BUS' }] : [],
        steps: Array.from({length:walkMin>0?1:0}, (_,i)=>({ type:'WALK', duration:`${walkMin} min` })),
        _isWalk: type==='WALK',
        _isBike: type==='BIKE',
        score: 100 - id,
        transfers
      };
    };

    document.getElementById('btn-generate-arrival').addEventListener('click', () => {
      const { rankArrivalItineraries } = window.__DEBUG;
      const searchTime = { type:'arriver', date:'today', hour:'14', minute:'30' };
      const sample = [
        createFakeItinerary(1,'BUS',14,0,1,5,25),
        createFakeItinerary(2,'BUS',14,-5,0,2,22),
        createFakeItinerary(3,'WALK',14,-2,0,10,10),
        createFakeItinerary(4,'BIKE',14,-8,0,0,12),
        createFakeItinerary(5,'BUS',14,-1,2,1,30)
      ];
      const ranked = rankArrivalItineraries(sample, searchTime);
      logJson(document.getElementById('arrival-log'), ranked.map(i=>({id:i.id, arr:i.arrivalTime, transf:i.transfers, walk:i.steps.filter(s=>s.type==='WALK').reduce((a,s)=>a+parseInt(s.duration,10),0), raw:i.durationRaw})));
    });

    document.getElementById('btn-test-dedup').addEventListener('click', () => {
      const { deduplicateItineraries } = window.__DEBUG;
      const base = createFakeItinerary(10,'BUS',15,0,1,0,20);
      const dup1 = { ...base }; // même signature
      const altered = { ...base, arrivalTime: '15:05' }; // signature différente
      const result = deduplicateItineraries([base, dup1, altered]);
      logJson(document.getElementById('dedup-log'), result.map(i=>({id:i.id, arrival:i.arrivalTime})));
    });

    document.getElementById('btn-test-render').addEventListener('click', () => {
      // Fake minimal state injection
      const host = document.getElementById('render-host');
      host.innerHTML = '<div class="results-list"></div>';
      window.allFetchedItineraries = [
        createFakeItinerary(20,'BUS',16,0,1,5,25),
        createFakeItinerary(21,'BUS',16,-3,0,0,18),
        createFakeItinerary(22,'BIKE',16,-5,0,0,12),
        createFakeItinerary(23,'WALK',16,-2,0,10,10)
      ];
      // Utiliser le renderer déjà instancié par main.js (car debug.html charge main.js)
      if (window.__DEBUG && window.__DEBUG._debugRender) {
        window.__DEBUG._debugRender('ALL');
      }
      // Déplacer le conteneur réel dans host si existant
      const realList = document.querySelector('#itinerary-results-container .results-list') || document.querySelector('.results-list');
      if (realList && host !== realList.parentNode) host.appendChild(realList);
    });

    document.getElementById('btn-test-utils').addEventListener('click', () => {
      const { computeTimeDifferenceMinutes, getWaitStepPresentation } = window.__DEBUG;
      const diff1 = computeTimeDifferenceMinutes('14:10','14:35');
      const steps = [
        { type:'BUS', arrivalTime:'14:10' },
        { type:'WAIT', _durationSeconds: 600 },
        { type:'BUS', departureTime:'14:20' }
      ];
      const waitPres = getWaitStepPresentation(steps,1);
      logJson(document.getElementById('utils-log'), { diff1, waitPres });
    });
  </script>
</body>
</html>
