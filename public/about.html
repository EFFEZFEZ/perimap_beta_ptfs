<!DOCTYPE html>
<html lang="fr" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         üéØ SEO ABOUT PAGE - P√âRIMAP
         Application officieuse P√©ribus P√©rigueux
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    
    <title>√Ä propos de P√©riMap | Application Bus P√©rigueux Gratuite | Open Source</title>
    <meta name="description" content="üöç D√©couvrez P√©riMap : l'application gratuite et open source pour les bus P√©ribus √† P√©rigueux. Horaires temps r√©el, calcul d'itin√©raires, donn√©es officielles GTFS du Grand P√©rigueux. Sans pub, sans compte !">
    
    <!-- SEO Meta Tags -->
    <meta name="keywords" content="p√©rimap, application p√©ribus, bus p√©rigueux gratuit, horaires p√©ribus, transport dordogne, open source transport, gtfs p√©rigueux, application bus gratuite, p√©ribus horaires, grand p√©rigueux transport, mobilit√© p√©rigueux">
    <meta name="author" content="P√©riMap - Projet Open Source">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="revisit-after" content="7 days">
    <meta name="rating" content="general">
    <meta name="distribution" content="global">
    
    <!-- Canonical & Alternate -->
    <link rel="canonical" href="https://perimap.fr/about.html">
    <link rel="alternate" hreflang="fr" href="https://perimap.fr/about.html">
    <link rel="alternate" hreflang="x-default" href="https://perimap.fr/about.html">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="P√©riMap">
    <meta property="og:title" content="√Ä propos de P√©riMap | Application Bus P√©rigueux Open Source">
    <meta property="og:description" content="üöç P√©riMap : votre assistant mobilit√© gratuit pour le r√©seau P√©ribus. Horaires en temps r√©el, itin√©raires optimis√©s, donn√©es ouvertes. Projet ind√©pendant et sans pub.">
    <meta property="og:url" content="https://perimap.fr/about.html">
    <meta property="og:image" content="https://perimap.fr/icons/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="√Ä propos de P√©riMap | Application Bus P√©rigueux">
    <meta name="twitter:description" content="üöç Application gratuite et open source pour les bus P√©ribus. Horaires temps r√©el, itin√©raires, sans pub ni compte !">
    <meta name="twitter:image" content="https://perimap.fr/icons/og-image.png">
    
    <!-- Geo Tags -->
    <meta name="geo.region" content="FR-NAQ">
    <meta name="geo.placename" content="P√©rigueux, Dordogne">
    <meta name="geo.position" content="45.1849;0.7214">
    <meta name="ICBM" content="45.1849, 0.7214">
    
    <!-- PWA -->
    <meta name="theme-color" content="#22c55e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="P√©riMap">
    <meta name="application-name" content="P√©riMap">
    <meta name="msapplication-TileColor" content="#22c55e">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Links -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png">
    <link rel="icon" type="image/webp" sizes="192x192" href="https://i.ibb.co/99PZh9Zq/export6-removebg-preview.webp">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="//api.github.com">
    
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Schema.org - About Page -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "AboutPage",
        "name": "√Ä propos de P√©riMap",
        "description": "P√©riMap est une application web progressive gratuite et open source pour consulter les horaires et itin√©raires du r√©seau P√©ribus √† P√©rigueux.",
        "url": "https://perimap.fr/about.html",
        "mainEntity": {
            "@type": "SoftwareApplication",
            "name": "P√©riMap",
            "applicationCategory": "TravelApplication",
            "operatingSystem": "Web, Android, iOS",
            "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "EUR"
            },
            "isAccessibleForFree": true,
            "license": "https://opensource.org/licenses/MIT"
        },
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Accueil P√©riMap",
                    "item": "https://perimap.fr/"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "√Ä propos",
                    "item": "https://perimap.fr/about.html"
                }
            ]
        }
    }
    </script>
    
    <!-- Schema.org - Organization -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "P√©riMap",
        "alternateName": "P√©ribus Horaires App",
        "url": "https://perimap.fr",
        "logo": "https://perimap.fr/icons/icon-512.png",
        "description": "Application citoyenne gratuite pour le r√©seau de bus P√©ribus du Grand P√©rigueux",
        "foundingDate": "2024",
        "areaServed": {
            "@type": "Place",
            "name": "Grand P√©rigueux",
            "address": {
                "@type": "PostalAddress",
                "addressLocality": "P√©rigueux",
                "addressRegion": "Dordogne",
                "addressCountry": "FR"
            }
        },
        "sameAs": [
            "https://github.com/EFFEZFEZ/p-rimap-sans-api-"
        ]
    }
    </script>
    
    <!-- Schema.org - FAQ -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "P√©riMap est-il gratuit ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Oui, P√©riMap est 100% gratuit, sans publicit√© et sans cr√©ation de compte. C'est un projet open source ind√©pendant."
                }
            },
            {
                "@type": "Question",
                "name": "P√©riMap est-il officiel ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Non, P√©riMap est un projet ind√©pendant non affili√© au Grand P√©rigueux ou √† P√©ribus. Il utilise les donn√©es ouvertes officielles (GTFS) sous licence ODbL."
                }
            },
            {
                "@type": "Question",
                "name": "D'o√π viennent les donn√©es de P√©riMap ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Les horaires proviennent des donn√©es GTFS officielles du Grand P√©rigueux publi√©es en open data. Les itin√©raires sont calcul√©s via l'API Google Routes pour plus de pr√©cision."
                }
            },
            {
                "@type": "Question",
                "name": "Comment installer P√©riMap sur mon t√©l√©phone ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "P√©riMap est une Progressive Web App (PWA). Sur Android, cliquez sur 'Ajouter √† l'√©cran d'accueil' dans Chrome. Sur iPhone, utilisez Safari et 'Sur l'√©cran d'accueil' dans le menu partage."
                }
            },
            {
                "@type": "Question",
                "name": "Puis-je utiliser P√©riMap hors connexion ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Oui, une fois install√©, P√©riMap fonctionne hors ligne pour consulter les horaires. Seul le calcul d'itin√©raire n√©cessite une connexion internet."
                }
            }
        ]
    }
    </script>
    <style>
        /* === ADMIN PANEL STYLES === */
        .tile-admin {
            background: transparent !important;
            box-shadow: none !important;
            padding: 0.5rem !important;
            text-align: center;
        }
        .admin-login-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
        }
        .admin-login-btn:hover {
            opacity: 1;
            background: var(--bg-tertiary);
        }
        
        .admin-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .admin-modal.hidden { display: none; }
        
        .admin-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
            position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .admin-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-muted);
        }
        .admin-close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .admin-screen h2 {
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }
        .admin-screen > p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        #admin-password {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        #admin-password:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .admin-error {
            color: var(--color-red);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        .admin-error.hidden { display: none; }
        
        .admin-subtitle {
            font-size: 0.85rem !important;
            margin-bottom: 1rem !important;
        }
        
        .admin-table-wrapper {
            overflow-x: auto;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .admin-table th {
            background: var(--bg-secondary);
            padding: 0.6rem 0.4rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .admin-table th:first-child {
            text-align: left;
            padding-left: 0.75rem;
        }
        .admin-table td {
            padding: 0.5rem 0.4rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .admin-table td:first-child {
            text-align: left;
            padding-left: 0.5rem;
        }
        .admin-table tr:last-child td {
            border-bottom: none;
        }
        .admin-table tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        .admin-line-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            color: white;
            min-width: 32px;
            text-align: center;
        }
        
        .admin-table input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }
        
        .admin-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .admin-actions .btn {
            flex: 1;
            padding: 0.75rem;
            font-size: 0.9rem;
        }
        
        .admin-status {
            text-align: center;
            margin-top: 0.75rem;
            font-size: 0.85rem;
            min-height: 1.2em;
        }
        .admin-status.success { color: var(--primary); }
        .admin-status.error { color: var(--color-red); }
        .admin-status.loading { color: var(--text-muted); }
        
        /* Category headers in table */
        .admin-table .category-row td {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.4rem 0.75rem;
        }
    </style>
</head>
<body class="about-page">
    <header id="main-header" class="about-header">
        <div class="header-content about-header-content">
            <div class="logo">
                <img src="https://i.ibb.co/99PZh9Zq/export6-removebg-preview.webp" alt="Logo P√©riMap" class="header-logo-img">
                <div class="header-title-group">
                    <span class="brand-name">P√©riMap</span>
                    <span class="brand-sub">Assistant mobilit√© Grand P√©rigueux</span>
                </div>
            </div>
            <nav class="header-nav">
                <button id="theme-toggle-btn" class="btn-icon-round" aria-label="Basculer th√®me sombre" title="Th√®me clair" aria-pressed="true">
                    <span id="theme-toggle-icon">‚òÄÔ∏è</span>
                </button>
            </nav>
        </div>
    </header>

    <main class="about-main">
        <div class="about-back-row">
            <a href="/" class="btn btn-secondary about-back-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                <span>Retour au menu</span>
            </a>
        </div>

        <div class="tile-layout">
        <section class="about-tile tile-primary" data-animate>
            <div>
                <div class="hero-badge">Open data ‚Ä¢ PWA</div>
                <h1>P√©riMap en clair</h1>
                <p class="hero-lede">Une carte rapide et l√©g√®re pour pr√©parer vos trajets dans le Grand P√©rigueux sans prise de t√™te.</p>
            </div>
            <ul class="tile-points">
                <li><span>Trajets fiables</span><small>Horaires officiels du Grand P√©rigueux + calcul Google Routes.</small></li>
                <li><span>Projet personnel</span><small>Fait par un passionn√©, pas par P√©ribus. Attribution ODbL respect√©e et base <code>gtfs.bundle.json</code> publique.</small></li>
                <li><span>Sans bruit</span><small>Pas de compte, pas de pub‚ÄØ: juste l'info n√©cessaire pour partir.</small></li>
            </ul>
            <a class="hero-link" href="https://github.com/EFFEZFEZ/p-rimap-sans-api-" target="_blank" rel="noopener">Voir le code source ‚Üí</a>
        </section>

        <section class="about-tile tile-secondary" data-animate>
            <div class="install-heading">
                <h2>Installer P√©riMap</h2>
                <p class="install-blurb">Pensez √† ajouter P√©riMap √† votre √©cran d'accueil üòâ √ßa ne prend aucune place !</p>
            </div>
            <p id="install-helper" class="install-helper"></p>
            <button id="install-pwa-btn" class="install-btn" disabled>Installer P√©riMap</button>
        </section>

        <!-- Bouton connexion personnel (discret) -->
        <section class="about-tile tile-admin" data-animate>
            <button id="admin-login-btn" class="admin-login-btn">üîê Connexion personnel</button>
        </section>
        </div>

        <!-- Modal Admin -->
        <div id="admin-modal" class="admin-modal hidden">
            <div class="admin-modal-content">
                <button id="admin-close-btn" class="admin-close-btn">√ó</button>
                
                <!-- √âcran de connexion -->
                <div id="admin-login-screen" class="admin-screen">
                    <h2>üîê Acc√®s Personnel</h2>
                    <p>Entrez le mot de passe pour acc√©der √† la gestion du trafic.</p>
                    <input type="password" id="admin-password" placeholder="Mot de passe" autocomplete="off">
                    <button id="admin-submit-pwd" class="btn btn-primary">Connexion</button>
                    <p id="admin-error" class="admin-error hidden">Mot de passe incorrect</p>
                </div>
                
                <!-- Tableau de gestion -->
                <div id="admin-panel" class="admin-screen hidden">
                    <h2>üìä Gestion Trafic</h2>
                    <p class="admin-subtitle">Cochez les cases pour modifier l'√©tat des lignes</p>
                    
                    <div class="admin-table-wrapper">
                        <table id="admin-table" class="admin-table">
                            <thead>
                                <tr>
                                    <th>Ligne</th>
                                    <th>Normal</th>
                                    <th>Retard</th>
                                    <th>Perturbation</th>
                                    <th>Annulation</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body"></tbody>
                        </table>
                    </div>
                    
                    <div class="admin-actions">
                        <button id="admin-save-btn" class="btn btn-primary">üíæ Enregistrer sur GitHub</button>
                        <button id="admin-reset-btn" class="btn btn-secondary">üîÑ Tout r√©initialiser</button>
                    </div>
                    <p id="admin-status" class="admin-status"></p>
                </div>
            </div>
        </div>
    </main>

    <footer id="legal-strip">
        <div class="legal-strip-content">
            <span class="legal-pill">Application ind√©pendante, non affili√©e au Grand P√©rigueux.</span>
            <span>Donn√©es ¬© Grand P√©rigueux / P√©ribus ‚Äî licence ODbL.</span>
            <span>
                Base d√©riv√©e <code>gtfs.bundle.json</code> partag√©e sur
                <a href="https://github.com/EFFEZFEZ/p-rimap-sans-api-/tree/main/public/data/gtfs" target="_blank" rel="noopener">GitHub</a>.
            </span>
            <a class="legal-about-btn" href="/mentions-legales.html">Mentions l√©gales</a>
        </div>
    </footer>

    <script>
    (function themeSetup() {
        const body = document.body;
        const toggle = document.getElementById('theme-toggle-btn');
        if (!toggle) return;
        const icon = document.getElementById('theme-toggle-icon');
        const applyTheme = (isDark) => {
            body.classList.toggle('dark-theme', isDark);
            toggle?.setAttribute('aria-pressed', String(isDark));
            if (icon) icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        };
        let saved = null;
        try { saved = localStorage.getItem('ui-theme'); } catch (_) {}
        const prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(saved ? saved === 'dark' : prefers);
        toggle?.addEventListener('click', () => {
            const next = !body.classList.contains('dark-theme');
            applyTheme(next);
            try { localStorage.setItem('ui-theme', next ? 'dark' : 'light'); } catch (_) {}
        });
    })();

    (function installCTA() {
        const installBtn = document.getElementById('install-pwa-btn');
        if (!installBtn) return;
        const helper = document.getElementById('install-helper');
        const ua = navigator.userAgent.toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(ua);
        const isAndroid = !isIOS && ua.includes('android');

        const setHelper = (text) => { if (helper) helper.textContent = text; };
        const redirectToHallForInstall = () => {
            try { sessionStorage.setItem('perimapInstallTip', 'true'); } catch (_) {}
            window.location.href = '/';
        };

        if (isAndroid) {
            setHelper('Android d√©tect√© : appuyez sur Installer, vous serez redirig√© vers le hall avec la proc√©dure.');
        } else if (isIOS) {
            setHelper('iOS d√©tect√© : Safari vous proposera Sur l\'√©cran d\'accueil une fois de retour sur le hall.');
        } else {
            setHelper('Navigateur compatible : cliquez sur Installer pour revenir au hall avec les explications.');
        }

        installBtn.disabled = false;
        installBtn.textContent = 'Installer P√©riMap';
        installBtn.addEventListener('click', redirectToHallForInstall);
    })();

    (function tileObserver() {
        const tiles = document.querySelectorAll('[data-animate]');
        if (!tiles.length) return;

        const reveal = (tile) => tile.classList.add('is-visible');

        if (!('IntersectionObserver' in window)) {
            tiles.forEach(reveal);
            return;
        }

        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) return;
                reveal(entry.target);
                obs.unobserve(entry.target);
            });
        }, { threshold: 0.35 });

        tiles.forEach(tile => observer.observe(tile));
    })();

    (function ensureServiceWorker() {
        if (!('serviceWorker' in navigator)) return;
        navigator.serviceWorker.getRegistration('/').then((registration) => {
            if (registration) return;
            navigator.serviceWorker.register('/service-worker.js').catch(() => {
                console.warn('Impossible d\'enregistrer le service worker depuis la page √Ä propos.');
            });
        }).catch(() => {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {
                console.warn('Impossible d\'enregistrer le service worker depuis la page √Ä propos.');
            });
        });
    })();

    // === ADMIN PANEL ===
    (function adminPanel() {
        // Config - MOT DE PASSE (change-le !)
        const ADMIN_PASSWORD = 'perimap2024';
        
        // GitHub config
        const GITHUB_OWNER = 'EFFEZFEZ';
        const GITHUB_REPO = 'p-rimap-sans-api-';
        const GITHUB_FILE_PATH = 'public/data/line-status.json';
        const GITHUB_BRANCH = 'main';
        
        // Token GitHub stock√© localement apr√®s premi√®re connexion
        let githubToken = null;
        try { githubToken = localStorage.getItem('perimap-gh-token'); } catch(_) {}
        
        // Lignes √† g√©rer
        const LINES = {
            'Majeures': [
                { id: 'A', color: '#E30613' },
                { id: 'B', color: '#009EE0' },
                { id: 'C', color: '#FFD500', text: '#000' },
                { id: 'D', color: '#00A650' }
            ],
            'Express': [
                { id: 'e1', color: '#8B4513' },
                { id: 'e2', color: '#8B4513' },
                { id: 'e4', color: '#8B4513' },
                { id: 'e5', color: '#8B4513' },
                { id: 'e6', color: '#8B4513' },
                { id: 'e7', color: '#8B4513' }
            ],
            'Quartier': [
                { id: 'K1A', color: '#9C27B0' },
                { id: 'K1B', color: '#9C27B0' },
                { id: 'K2', color: '#9C27B0' },
                { id: 'K3A', color: '#9C27B0' },
                { id: 'K3B', color: '#9C27B0' },
                { id: 'K4A', color: '#9C27B0' },
                { id: 'K4B', color: '#9C27B0' },
                { id: 'K5', color: '#9C27B0' },
                { id: 'K6', color: '#9C27B0' }
            ],
            'Navettes': [
                { id: 'N', color: '#607D8B' },
                { id: 'N1', color: '#607D8B' }
            ]
        };
        
        const STATUSES = ['normal', 'retard', 'perturbation', 'annulation'];
        
        // Elements
        const loginBtn = document.getElementById('admin-login-btn');
        const modal = document.getElementById('admin-modal');
        const closeBtn = document.getElementById('admin-close-btn');
        const loginScreen = document.getElementById('admin-login-screen');
        const panel = document.getElementById('admin-panel');
        const passwordInput = document.getElementById('admin-password');
        const submitPwd = document.getElementById('admin-submit-pwd');
        const errorMsg = document.getElementById('admin-error');
        const tableBody = document.getElementById('admin-table-body');
        const saveBtn = document.getElementById('admin-save-btn');
        const resetBtn = document.getElementById('admin-reset-btn');
        const statusEl = document.getElementById('admin-status');
        
        if (!loginBtn || !modal) return;
        
        let currentStatuses = {};
        let fileSha = null; // SHA du fichier pour update GitHub
        
        // Ouvrir modal
        loginBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            // Si d√©j√† authentifi√©, aller direct au panel
            try {
                if (sessionStorage.getItem('perimap-admin-auth') === 'true') {
                    showPanel();
                }
            } catch(_) {}
        });
        
        // Fermer modal
        closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        });
        
        // Soumettre mot de passe
        submitPwd.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
        
        function checkPassword() {
            const pwd = passwordInput.value.trim();
            if (pwd === ADMIN_PASSWORD) {
                errorMsg.classList.add('hidden');
                try { sessionStorage.setItem('perimap-admin-auth', 'true'); } catch(_) {}
                
                // Demander le token GitHub si pas d√©j√† enregistr√©
                if (!githubToken) {
                    githubToken = prompt('Token GitHub (avec acc√®s repo) pour pouvoir sauvegarder :\n\nCr√©ez-en un sur github.com/settings/tokens');
                    if (githubToken) {
                        try { localStorage.setItem('perimap-gh-token', githubToken); } catch(_) {}
                    }
                }
                
                showPanel();
            } else {
                errorMsg.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        async function showPanel() {
            loginScreen.classList.add('hidden');
            panel.classList.remove('hidden');
            
            // Charger les statuts actuels
            await loadCurrentStatuses();
            buildTable();
        }
        
        async function loadCurrentStatuses() {
            setStatus('Chargement...', 'loading');
            try {
                const response = await fetch('/data/line-status.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    currentStatuses = {};
                    if (data.lines) {
                        for (const [lineId, info] of Object.entries(data.lines)) {
                            if (!lineId.startsWith('_')) {
                                currentStatuses[lineId] = info.status || 'normal';
                            }
                        }
                    }
                }
                setStatus('');
            } catch (e) {
                setStatus('Erreur chargement', 'error');
            }
        }
        
        function buildTable() {
            tableBody.innerHTML = '';
            
            for (const [category, lines] of Object.entries(LINES)) {
                // Ligne de cat√©gorie
                const catRow = document.createElement('tr');
                catRow.className = 'category-row';
                catRow.innerHTML = `<td colspan="5">${category}</td>`;
                tableBody.appendChild(catRow);
                
                // Lignes
                lines.forEach(line => {
                    const status = currentStatuses[line.id] || 'normal';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <span class="admin-line-badge" style="background:${line.color};color:${line.text||'#fff'}">
                                ${line.id}
                            </span>
                        </td>
                        ${STATUSES.map(s => `
                            <td>
                                <input type="radio" name="status-${line.id}" value="${s}" ${status === s ? 'checked' : ''}>
                            </td>
                        `).join('')}
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        // R√©initialiser tout
        resetBtn.addEventListener('click', () => {
            if (confirm('Remettre toutes les lignes en "normal" ?')) {
                document.querySelectorAll('input[value="normal"]').forEach(r => r.checked = true);
                setStatus('Tout r√©initialis√© (cliquez Enregistrer)', 'success');
            }
        });
        
        // Sauvegarder sur GitHub
        saveBtn.addEventListener('click', saveToGitHub);
        
        async function saveToGitHub() {
            if (!githubToken) {
                githubToken = prompt('Token GitHub requis :');
                if (!githubToken) return;
                try { localStorage.setItem('perimap-gh-token', githubToken); } catch(_) {}
            }
            
            setStatus('Sauvegarde en cours...', 'loading');
            
            // Collecter les statuts depuis le tableau
            const newStatuses = {};
            for (const [category, lines] of Object.entries(LINES)) {
                lines.forEach(line => {
                    const radio = document.querySelector(`input[name="status-${line.id}"]:checked`);
                    newStatuses[line.id] = { 
                        status: radio ? radio.value : 'normal',
                        message: ''
                    };
                });
            }
            
            // Construire le JSON complet
            const jsonContent = {
                lastUpdate: new Date().toISOString(),
                globalMessage: '',
                lines: newStatuses,
                _documentation: {
                    status_values: [
                        'normal - Trafic normal',
                        'retard - Retards sur la ligne',
                        'perturbation - Perturbation en cours',
                        'annulation - Service annul√©'
                    ]
                }
            };
            
            try {
                // 1. R√©cup√©rer le SHA actuel du fichier
                const getResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}?ref=${GITHUB_BRANCH}`,
                    { headers: { 'Authorization': `token ${githubToken}` } }
                );
                
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    fileSha = fileData.sha;
                }
                
                // 2. Mettre √† jour le fichier
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonContent, null, 2))));
                
                const updateResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `[Admin] Mise √† jour trafic - ${new Date().toLocaleString('fr-FR')}`,
                            content: content,
                            sha: fileSha,
                            branch: GITHUB_BRANCH
                        })
                    }
                );
                
                if (updateResponse.ok) {
                    setStatus('‚úÖ Sauvegard√© sur GitHub !', 'success');
                    // Mettre √† jour les statuts locaux
                    for (const [id, info] of Object.entries(newStatuses)) {
                        currentStatuses[id] = info.status;
                    }
                } else {
                    const err = await updateResponse.json();
                    throw new Error(err.message || 'Erreur GitHub');
                }
                
            } catch (error) {
                console.error('Erreur GitHub:', error);
                setStatus('‚ùå Erreur: ' + error.message, 'error');
                
                // Si erreur de token, proposer de le re-saisir
                if (error.message.includes('401') || error.message.includes('Bad credentials')) {
                    githubToken = null;
                    try { localStorage.removeItem('perimap-gh-token'); } catch(_) {}
                }
            }
        }
        
        function setStatus(msg, type = '') {
            statusEl.textContent = msg;
            statusEl.className = 'admin-status ' + type;
        }
    })();
    </script>
</body>
</html>
