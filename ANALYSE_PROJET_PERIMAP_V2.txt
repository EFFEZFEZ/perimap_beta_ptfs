================================================================================
               ANALYSE TECHNIQUE APPROFONDIE - PÃ‰RIMAP V220
                     Mise Ã  jour : 6 dÃ©cembre 2025
================================================================================

================================================================================
1. RÃ‰SUMÃ‰ EXÃ‰CUTIF
================================================================================

PÃ©rimap est une PWA de planification de trajets bus pour le rÃ©seau PÃ©ribus
(Grand PÃ©rigueux). Version actuelle : V220 (Service Worker).

STACK TECHNIQUE :
- Frontend : Vanilla JS (ES Modules), Leaflet, CSS Grid/Flexbox
- Backend : Proxies Vercel (Node.js) - /api/routes, /api/places, /api/geocode
- DonnÃ©es : GTFS statiques + Google Routes API (temps rÃ©el)
- Cache : IndexedDB + Service Worker

CE QUI FONCTIONNE (aprÃ¨s 8h de debug) :
âœ… Mode "partir Ã " : 8 appels API dÃ©calÃ©s sur 3h, max 8 rÃ©sultats
âœ… Mode "arriver Ã " : 1 appel API, filtrage par heure actuelle (pas demandÃ©e)
âœ… DÃ©duplication intelligente par heure+ligne+arrÃªt
âœ… Extraction correcte des heures de dÃ©part depuis Google Routes API

================================================================================
2. ARCHITECTURE DU CODE - FLUX DE DONNÃ‰ES CRITIQUES
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FLUX DE RECHERCHE D'ITINÃ‰RAIRE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  [1] UTILISATEUR
       â”‚
       â–¼
  [2] uiManager.js â†’ Collecte from/to/searchTime
       â”‚
       â–¼
  [3] main.js::executeItinerarySearch()
       â”‚
       â”œâ”€â”€â–º [4a] router.js (GTFS local) â†’ 0 rÃ©sultats (souvent)
       â”‚
       â””â”€â”€â–º [4b] apiManager.js::fetchItinerary() â—„â”€â”€ CRITIQUE
                  â”‚
                  â”œâ”€â”€ Mode "partir" : 8 appels API dÃ©calÃ©s (T+0 Ã  T+180min)
                  â”‚
                  â””â”€â”€ Mode "arriver" : 1 seul appel API (V219)
                        â”‚
                        â–¼
              [5] extractDepartureTime() â—„â”€â”€ BUG CORRIGÃ‰ V217
                  â”‚   (extrait l'heure depuis transitDetails)
                  â–¼
              [6] DÃ©duplication par uniqueKey â—„â”€â”€ BUG CORRIGÃ‰ V217
                  â”‚   (clÃ© = "depTime-lineName-depStopName")
                  â–¼
              [7] Tri par heure de dÃ©part
                  â”‚
                  â–¼
              [8] Limite Ã  8 rÃ©sultats (V218)
                  â”‚
                  â–¼
  [9] main.js::processIntelligentResults()
       â”‚
       â–¼
  [10] ranking.js::filterExpiredDepartures() â—„â”€â”€ BUG CORRIGÃ‰ V220
       â”‚   (Mode arriver : filtre par heure ACTUELLE)
       â–¼
  [11] ranking.js::filterLateArrivals()
       â”‚   (Mode arriver : filtre arrivÃ©es > heure demandÃ©e)
       â–¼
  [12] resultsRenderer.js â†’ Affichage

================================================================================
3. FICHIERS CRITIQUES - NE PAS CASSER
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FICHIER              â”‚ RÃ”LE                     â”‚ ZONES SENSIBLES           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ apiManager.js        â”‚ Appels Google Routes API â”‚ â€¢ extractDepartureTime()  â”‚
â”‚ (1117 lignes)        â”‚ DÃ©duplication            â”‚ â€¢ uniqueKey construction  â”‚
â”‚                      â”‚ Multi-appels dÃ©calÃ©s     â”‚ â€¢ _offsetSearchTime()     â”‚
â”‚                      â”‚                          â”‚ â€¢ Mode arriver (1 appel)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ranking.js           â”‚ Filtrage/tri rÃ©sultats   â”‚ â€¢ filterExpiredDepartures â”‚
â”‚ (374 lignes)         â”‚                          â”‚   â†’ V220: heure actuelle  â”‚
â”‚                      â”‚                          â”‚     si mode arriver       â”‚
â”‚                      â”‚                          â”‚ â€¢ filterLateArrivals()    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ main.js              â”‚ Orchestration            â”‚ â€¢ executeItinerarySearch  â”‚
â”‚ (4607 lignes)        â”‚                          â”‚ â€¢ processIntelligentResultsâ”‚
â”‚                      â”‚                          â”‚ â€¢ loadMoreDepartures()    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ dataManager.js       â”‚ DonnÃ©es GTFS             â”‚ â€¢ getTripsBetweenStops()  â”‚
â”‚ (1570 lignes)        â”‚ Recherche locale         â”‚ â€¢ getServiceIds()         â”‚
â”‚                      â”‚                          â”‚ â€¢ timeToSeconds()         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ router.js            â”‚ Routage GTFS local       â”‚ â€¢ computeHybridItinerary  â”‚
â”‚                      â”‚ (souvent 0 rÃ©sultats)    â”‚ â€¢ correspondances         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ service-worker.js    â”‚ Cache PWA                â”‚ â€¢ CACHE_VERSION           â”‚
â”‚                      â”‚                          â”‚   (incrÃ©mentÃ© Ã  chaque    â”‚
â”‚                      â”‚                          â”‚    dÃ©ploiement)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
4. BUGS MAJEURS CORRIGÃ‰S - HISTORIQUE DES 8H DE DEBUG
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUG                          â”‚ CAUSE                    â”‚ FIX               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Saut d'horaires              â”‚ Mauvais chemin pour      â”‚ V217: Helper      â”‚
â”‚ (14:04 â†’ 15:53)              â”‚ extraire depTime         â”‚ extractDeparture- â”‚
â”‚                              â”‚ route.legs[0].localized  â”‚ Time() qui        â”‚
â”‚                              â”‚ Values... = vide pour    â”‚ parcourt steps[]  â”‚
â”‚                              â”‚ TRANSIT                  â”‚ TRANSIT           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DÃ©duplication trop           â”‚ uniqueKey = ""-lineName  â”‚ V217: ClÃ© =       â”‚
â”‚ agressive                    â”‚ (depTime vide)           â”‚ depTime-line-stop â”‚
â”‚ 39 routes â†’ 3                â”‚                          â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mode arriver = 0 bus         â”‚ 8 appels avec arrivalTimeâ”‚ V219: 1 seul      â”‚
â”‚                              â”‚ dÃ©calÃ©s dans le PASSÃ‰    â”‚ appel en mode     â”‚
â”‚                              â”‚ (T-20, T-40...) = aucun  â”‚ arriver           â”‚
â”‚                              â”‚ rÃ©sultat                 â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mode arriver filtre          â”‚ filterExpiredDepartures  â”‚ V220: En mode     â”‚
â”‚ tous les bus                 â”‚ comparait dÃ©part vs      â”‚ arriver, comparer â”‚
â”‚                              â”‚ heure DEMANDÃ‰E (arrivÃ©e) â”‚ Ã  heure ACTUELLE  â”‚
â”‚                              â”‚ Ex: 15:32 < 17:10 â†’ filtrâ”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
5. CHEMINS D'EXTRACTION DE DONNÃ‰ES GOOGLE ROUTES API
================================================================================

STRUCTURE RÃ‰PONSE GOOGLE ROUTES API (mode TRANSIT) :

route
â”œâ”€â”€ duration: "3660s"
â”œâ”€â”€ distanceMeters: 12500
â”œâ”€â”€ polyline: { encodedPolyline: "..." }
â””â”€â”€ legs[]
    â””â”€â”€ [0]
        â”œâ”€â”€ localizedValues
        â”‚   â””â”€â”€ departureTime  â—„â”€â”€ VIDE pour TRANSIT !
        â”‚       â””â”€â”€ time.text: ""
        â””â”€â”€ steps[]
            â”œâ”€â”€ [0] travelMode: "WALK" (marche vers arrÃªt)
            â”œâ”€â”€ [1] travelMode: "TRANSIT" â—„â”€â”€ C'EST LÃ€
            â”‚   â””â”€â”€ transitDetails
            â”‚       â”œâ”€â”€ transitLine
            â”‚       â”‚   â”œâ”€â”€ nameShort: "A"
            â”‚       â”‚   â””â”€â”€ name: "Ligne A"
            â”‚       â”œâ”€â”€ localizedValues
            â”‚       â”‚   â”œâ”€â”€ departureTime
            â”‚       â”‚   â”‚   â””â”€â”€ time.text: "14:04" â—„â”€â”€ BONNE VALEUR
            â”‚       â”‚   â””â”€â”€ arrivalTime
            â”‚       â”‚       â””â”€â”€ time.text: "14:52"
            â”‚       â””â”€â”€ stopDetails
            â”‚           â”œâ”€â”€ departureStop.name: "Gare SNCF"
            â”‚           â””â”€â”€ arrivalStop.name: "Mairie"
            â””â”€â”€ [2] travelMode: "WALK" (marche finale)

RÃˆGLE D'OR : Pour les routes TRANSIT, toujours parcourir steps[] et chercher
             travelMode === 'TRANSIT', puis extraire de transitDetails.

================================================================================
6. LOGIQUE MODE "PARTIR" vs MODE "ARRIVER"
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              MODE "PARTIR Ã€"                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Utilisateur veut PARTIR Ã  une heure prÃ©cise                               â”‚
â”‚ â€¢ 8 appels API dÃ©calÃ©s : T+0, T+20, T+40, T+60, T+90, T+120, T+150, T+180  â”‚
â”‚ â€¢ API reÃ§oit departureTime = heure de dÃ©part souhaitÃ©e                      â”‚
â”‚ â€¢ Filtrage : garder dÃ©parts >= heure demandÃ©e                               â”‚
â”‚ â€¢ Tri : dÃ©part croissant (le plus tÃ´t en premier)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              MODE "ARRIVER Ã€"                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Utilisateur veut ARRIVER avant une heure prÃ©cise                          â”‚
â”‚ â€¢ 1 SEUL appel API (V219) - Google gÃ¨re les alternatives                    â”‚
â”‚ â€¢ API reÃ§oit arrivalTime = heure d'arrivÃ©e souhaitÃ©e                        â”‚
â”‚ â€¢ Filtrage V220 :                                                           â”‚
â”‚   - DÃ©parts : garder ceux >= heure ACTUELLE (pas demandÃ©e !)               â”‚
â”‚   - ArrivÃ©es : garder ceux <= heure demandÃ©e                                â”‚
â”‚ â€¢ Tri : arrivÃ©e DÃ‰CROISSANTE (le plus proche de l'heure cible en premier)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
7. DÃ‰DUPLICATION - RÃˆGLES
================================================================================

OBJECTIF : Ã‰viter d'afficher le mÃªme trajet plusieurs fois (mÃªme bus, mÃªme
           arrÃªts) juste parce qu'il apparaÃ®t dans plusieurs appels API.

CLÃ‰ UNIQUE (V217) :
  uniqueKey = `${depTime}-${lineName}-${depStopName}`

EXEMPLES :
  "14:04-A-Gare SNCF"     âœ“ GardÃ©
  "14:04-A-Gare SNCF"     âœ— Doublon, ignorÃ©
  "14:24-A-Gare SNCF"     âœ“ GardÃ© (heure diffÃ©rente)
  "14:04-B-Gare SNCF"     âœ“ GardÃ© (ligne diffÃ©rente)
  "14:04-A-Place Tourny"  âœ“ GardÃ© (arrÃªt diffÃ©rent)

PIÃˆGE CORRIGÃ‰ V217 :
  Si depTime = "" (vide), tous les trajets ont la mÃªme clÃ© "" â†’ 1 seul gardÃ© !

================================================================================
8. CONSTANTES IMPORTANTES Ã€ CONNAÃTRE
================================================================================

apiManager.js :
  - MAX_BUS_RESULTS = 8 (slice(0, 8) ligne ~718)
  - Offsets mode partir : [0, 20, 40, 60, 90, 120, 150, 180] minutes

ranking.js :
  - MIN_BUS_ITINERARIES = 5 (warning si moins)
  - Marge de filtrage : -2 minutes (ligne ~181)

main.js :
  - ARRIVAL_PAGE_SIZE = 6 (pagination mode arriver)
  - ENABLE_GTFS_ROUTER = true (V189+)

service-worker.js :
  - CACHE_VERSION = 'v220' (incrÃ©mentÃ© Ã  CHAQUE dÃ©ploiement)

================================================================================
9. CHECKLIST DEBUG - SAUTS D'HORAIRES
================================================================================

Si les horaires sautent (ex: 14:04 â†’ 15:53 sans bus entre) :

1. VÃ‰RIFIER LES LOGS CONSOLE :
   â€¢ "ğŸ“‹ Horaires: 14:04, 14:24, 14:52..." â†’ extraction OK
   â€¢ "ğŸ“‹ Horaires: , , ..." â†’ extraction CASSÃ‰E (V217)

2. VÃ‰RIFIER LA DÃ‰DUPLICATION :
   â€¢ "ğŸš V218: 8/21 trajets" â†’ OK
   â€¢ "ğŸš V218: 1/21 trajets" â†’ uniqueKey probablement cassÃ©e

3. VÃ‰RIFIER LE FILTRAGE :
   â€¢ "ğŸ• V205: Filtrage des trajets avant 14:00" â†’ mode partir OK
   â€¢ "ğŸ• V220: Mode ARRIVER - Filtrage... heure actuelle" â†’ mode arriver OK
   â€¢ "ğŸš« X trajet(s) passÃ©(s) filtrÃ©(s)" â†’ normal si X < total

4. VÃ‰RIFIER LE MODE :
   â€¢ "â° Mode: partir" ou "â° Mode: arriver" dans les logs

5. POINTS DE RUPTURE POTENTIELS :
   â€¢ apiManager.js ligne ~660 : extractDepartureTime()
   â€¢ apiManager.js ligne ~700 : construction uniqueKey
   â€¢ ranking.js ligne ~160 : filterExpiredDepartures

================================================================================
10. AMÃ‰LIORATIONS FUTURES RECOMMANDÃ‰ES
================================================================================

HAUTE PRIORITÃ‰ :
[ ] Tests unitaires pour ranking.js (filterExpiredDepartures, etc.)
[ ] Tests d'intÃ©gration pour apiManager.fetchItinerary()
[ ] Logging structurÃ© (JSON) pour faciliter le debug

MOYENNE PRIORITÃ‰ :
[ ] Cache des rÃ©sultats Google Routes (Ã©viter re-appels identiques)
[ ] MÃ©triques de performance (temps de rÃ©ponse API, taux d'erreur)
[ ] Mode hors-ligne amÃ©liorÃ© (cache des derniers trajets cherchÃ©s)

BASSE PRIORITÃ‰ :
[ ] Refactoring main.js (4607 lignes â†’ dÃ©couper en modules)
[ ] TypeScript pour type safety
[ ] Documentation JSDoc complÃ¨te

================================================================================
11. COMMANDES GIT UTILES
================================================================================

# Voir les changements rÃ©cents sur un fichier critique
git log --oneline -20 -- public/js/apiManager.js

# Comparer avec une version prÃ©cÃ©dente
git diff v217..v220 -- public/js/apiManager.js

# Revenir Ã  une version fonctionnelle (en cas de rÃ©gression)
git checkout v217 -- public/js/apiManager.js

# CrÃ©er un tag de version stable
git tag -a v220-stable -m "Mode arriver fonctionnel"

================================================================================
12. CONTACT & MAINTENANCE
================================================================================

Repository : https://github.com/EFFEZFEZ/p-rimap-sans-api-
Production : https://pÃ©rimap.fr (Vercel)

En cas de bug horaires :
1. VÃ©rifier CACHE_VERSION dans service-worker.js
2. Forcer refresh navigateur (Ctrl+Shift+R)
3. VÃ©rifier les logs console pour identifier l'Ã©tape cassÃ©e
4. Se rÃ©fÃ©rer Ã  cette analyse pour comprendre le flux

================================================================================
                            FIN DE L'ANALYSE V2
================================================================================
