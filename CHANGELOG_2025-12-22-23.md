# ğŸ“‹ Changelog PÃ©riMap - 22-23 DÃ©cembre 2025

## ğŸ¯ RÃ©sumÃ©

Session intensive de stabilisation Docker/OTP, amÃ©lioration UX itinÃ©raires, et implÃ©mentation de la **dÃ©tection autonome des pÃ©riodes horaires** (vacances/fÃ©riÃ©s).

---

## ğŸ“… 22 DÃ©cembre 2025

### ğŸ³ Stabilisation Docker & OTP

**Commit:** `ea1dec6` - chore: harden logging, GTFS colors, SW nav cache, healthchecks

- **Healthchecks amÃ©liorÃ©s** : conteneurs OTP et API avec vÃ©rifications robustes
- **Logs structurÃ©s** : nettoyage des logs serveur, rotation configurÃ©e
- **Service Worker** : stratÃ©gie network-first pour navigation HTML (Ã©vite mix JS ancien/nouveau)
- **Couleurs GTFS** : normalisation hexadÃ©cimale dans tout le pipeline

### ğŸšŒ Correction itinÃ©raires absurdes

**Commit:** `3d69857` - fix: merge consecutive same-line bus legs

- **ProblÃ¨me** : OTP proposait parfois "terminus + attendre + reprendre la mÃªme ligne"
- **Solution** : fusion des legs consÃ©cutifs sur la mÃªme ligne dans `itineraryProcessor.js`
- **Impact** : itinÃ©raires plus "humains", moins de faux dÃ©tours

### ğŸ“… Feature "PÃ©riodes horaires" (Phase 1)

**Commit:** `7aad010` - feat: schedule period banner + roadmap

- **Bandeau "Horaires adaptÃ©s"** dans la vue Horaires
- **Logique GTFS** : dÃ©tection via `calendar.txt` + `calendar_dates.txt`
- **CrÃ©ation `DEV_ROADMAP.md`** : plan de dÃ©veloppement sur 4 phases

---

## ğŸ“… 23 DÃ©cembre 2025

### ğŸ› Corrections bandeau pÃ©riodes

**Commits:** `af5997c`, `6c9da50`, `b94668f`

- **Fix collision CSS** : le bandeau hall et celui des horaires se mÃ©langeaient â†’ id `#hall-news-banner`
- **Wording** : "Horaires adaptÃ©s" au lieu de "Service spÃ©cial"
- **Baseline amÃ©liorÃ©e** : calcul sur fenÃªtre passÃ©e J-42 Ã  J-14 (Ã©vite pollution vacances)

### âœ… DÃ©tection autonome vacances GTFS

**Commit:** `be1da8f` - feat(pÃ©riodes): dÃ©tection autonome vacances GTFS + bandeau hall dynamique

#### ProblÃ¨me initial
La dÃ©tection des "horaires adaptÃ©s" ne fonctionnait pas car :
1. La baseline incluait les jours de vacances en cours â†’ ambiguÃ«
2. La comparaison J-7 Ã©chouait si la semaine prÃ©cÃ©dente avait des exceptions
3. Le Service Worker crashait sur `chrome-extension://` â†’ JS pas Ã  jour

#### Solution implÃ©mentÃ©e

**1. Baseline robuste (J-42 Ã  J-14)**
```javascript
// dataManager.js - ensureBaselineSignatures()
// FenÃªtre de rÃ©fÃ©rence: 3-6 semaines dans le passÃ©
// Ã‰vite de polluer la baseline avec les vacances actuelles
const startLimit = new Date(now);
startLimit.setDate(now.getDate() - 42);
const endLimit = new Date(now);
endLimit.setDate(now.getDate() - 14);
```

**2. DÃ©tection via J-14/21/28**
```javascript
// Si au moins 2 des 3 rÃ©fÃ©rences ont une signature diffÃ©rente â†’ pÃ©riode spÃ©ciale
for (const offset of [14, 21, 28]) {
    const refDay = new Date(d);
    refDay.setDate(d.getDate() - offset);
    const refSig = this.getServiceSignature(refDay);
    if (refSig && refSig !== signature) differentCount++;
}
if (differentCount >= 2) return { type: 'adapted', ... };
```

**3. "Ã€ venir" intelligent**
- Skip les jours "adapted" de la fenÃªtre en cours (dÃ©jÃ  affichÃ©s dans le bandeau)
- Garde les jours "aucun service" (25/12, 28/12, 01/01) individuellement
- Regroupe les pÃ©riodes futures en blocs

**4. Fix Service Worker**
```javascript
// Ignore les schÃ©mas non supportÃ©s (chrome-extension://)
if (url.protocol !== 'http:' && url.protocol !== 'https:') {
    event.respondWith(fetch(request));
    return;
}
```

**5. Bandeau hall avec dÃ©filement**
- Texte dÃ©file automatiquement si trop long pour l'Ã©cran
- Animation marquee rÃ©utilisÃ©e du systÃ¨me de perturbations

---

## ğŸ“ Fichiers modifiÃ©s (22-23/12)

| Fichier | Changements |
|---------|-------------|
| `public/js/dataManager.js` | +200 lignes : baseline, classification, fenÃªtre non-standard, upcoming |
| `public/js/main.js` | +100 lignes : bandeaux, renderScheduleUpcoming, refresh hall |
| `public/js/ui/trafficInfo.js` | +50 lignes : updateNewsBanner avec pÃ©riode + marquee |
| `public/views/trafic.html` | Retrait bandeau redondant Info Trafic |
| `public/views/horaires.html` | Bandeau #schedule-period-banner |
| `public/views/hall.html` | id #hall-news-banner |
| `public/service-worker.js` | Fix cache.put + version v252 |
| `DEV_ROADMAP.md` | Nouveau fichier (roadmap 4 phases) |

---

## ğŸ§ª Tests de validation

### DÃ©tection pÃ©riode vacances
```
Aujourd'hui (23/12) : Timetable:9,11
J-14 (09/12) : Timetable:6,7 â†’ DIFFÃ‰RENT
J-21 (02/12) : Timetable:6,7 â†’ DIFFÃ‰RENT  
J-28 (25/11) : Timetable:6,7 â†’ DIFFÃ‰RENT
â†’ 3/3 diffÃ©rents â†’ dÃ©tection OK âœ…
```

### Jours sans service dÃ©tectÃ©s
- 25/12/2025 : Aucun service âœ…
- 28/12/2025 : Aucun service âœ…
- 01/01/2026 : Aucun service âœ…

### UI validÃ©e
- Bandeau hall : "Horaires adaptÃ©s : pÃ©riode spÃ©ciale jusqu'au ven. 02/01" âœ…
- Ã€ venir : liste les jours sans service âœ…
- DÃ©filement texte sur mobile âœ…

---

## ğŸ“Š Commits complets (22-23/12)

| SHA | Message | Date |
|-----|---------|------|
| `be1da8f` | feat(pÃ©riodes): dÃ©tection autonome vacances GTFS + bandeau hall dynamique | 23/12 |
| `b94668f` | fix: detect adapted schedules using past baseline | 23/12 |
| `6c9da50` | chore: label GTFS special service as horaires adaptes | 23/12 |
| `af5997c` | fix: schedule banners + upcoming periods | 23/12 |
| `7aad010` | feat: schedule period banner + roadmap | 22/12 |
| `3d69857` | fix: merge consecutive same-line bus legs | 22/12 |
| `ea1dec6` | chore: harden logging, GTFS colors, SW nav cache, healthchecks | 22/12 |

---

## ğŸš€ FonctionnalitÃ©s livrÃ©es

### âœ… DÃ©tection autonome des pÃ©riodes
- Le site lit automatiquement les calendriers GTFS
- Compare les signatures de service sur plusieurs semaines
- Affiche un bandeau clair quand les horaires changent

### âœ… Information utilisateur
- Hall : "Horaires adaptÃ©s : pÃ©riode spÃ©ciale jusqu'au [date]"
- Ã€ venir : liste des prochains jours sans service
- Horaires : bandeau contextuel

### âœ… ItinÃ©raires amÃ©liorÃ©s
- Plus de "terminus + attendre + reprendre"
- Fusion des legs consÃ©cutifs mÃªme ligne

### âœ… Infrastructure stable
- Service Worker robuste (pas de crash chrome-extension)
- Healthchecks Docker fonctionnels
- Logs propres

---

## ğŸ“ Documentation mise Ã  jour

- `DEV_ROADMAP.md` : crÃ©Ã© (roadmap 4 phases)
- `CHANGELOG_2025-12-22-23.md` : ce fichier

---

## ğŸ”® Prochaines Ã©tapes (cf. DEV_ROADMAP.md)

1. **Phase 1** : Messages "pas de passage" plus pÃ©dagogiques
2. **Phase 2** : RÃ¨gles anti-absurde supplÃ©mentaires itinÃ©raires
3. **Phase 3** : Pipeline mise Ã  jour GTFS/OTP
4. **Phase 4** : Auto-hÃ©bergement Photon
